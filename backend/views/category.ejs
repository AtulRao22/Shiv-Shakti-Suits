<%- include("includes/head") %>
<%- include("includes/navbar") %>
<div class="container py-0 position-relative features-container container1">
  <div class="section-header d-flex align-items-center justify-content-between mb-3">
   <h2 class="section-title">
  <%= categoryName === "all" 
      ? "All Collection" 
      : categoryName.charAt(0).toUpperCase() + categoryName.slice(1) + " Collection" %>
</h2>

  </div>

  <div class="row g-3">
    <% if (products && products.length > 0) { %>
      <% products.forEach(function(p){ %>
        <div class="col-6 col-sm-6 col-md-4 col-lg-4 product-item">
          <a class="product-link" href="/show/<%= p._id %>">
            <div class="product-card">
              <div class="product-image">
                <%
  let isInWishlist = (wishlist || []).some(
    w => w._id.toString() === p._id.toString()
  );
%>
    <!-- Wishlist Icon -->
<button class="wishlist-btn" data-id="<%= p._id %>">
      <i class="<%= isInWishlist ? 'fa-solid fa-heart text-danger' : 'fa-regular fa-heart' %>"></i>
    </button>

                <!-- Product Image -->
                <img src="<%= p.imageUrls && p.imageUrls.length ? p.imageUrls[0] : '/images/placeholder.png' %>" 
                     alt="<%= p.name %>">
              </div>

              <div class="product-info">
                <h3 class="product-name"><%= p.name %></h3>

                <div class="product-price">
                  <span class="sale-price">₹<%= p.salePrice %></span>
                  <% if (p.mrp && p.mrp > p.salePrice) { 
                       let discount = Math.round(((p.mrp - p.salePrice) / p.mrp) * 100);
                  %>
                    <span class="mrp">₹<%= p.mrp %></span>
                    <span class="discount">(<%= discount %>% OFF)</span>
                  <% } %>
                </div>
              </div>
            </div>
          </a>
        </div>
      <% }) %>
    <% } else { %>
      <p>No products found in this category.</p>
    <% } %>
  </div>
</div>




<%- include("includes/footer") %>
<style>
  @media (max-width: 480px) {
    .container1 {
    margin-top: 25px;
  }

  .section-header{
    margin-bottom: 10px;
  }
  }
  
</style>

<script>
 // Wishlist Button Functionality
  (function () {
  document.querySelectorAll(".wishlist-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
       e.preventDefault();    // stop <a href> navigation
      e.stopPropagation();   // stop bubbling to parent <a>
      const productId = btn.dataset.id;
      try {
        const res = await fetch(`/wishlist/toggle/${productId}`, { method: "POST" });
        const data = await res.json();

        if (data.success) {
          const icon = btn.querySelector("i");
          if (data.inWishlist) {
            icon.classList.remove("fa-regular");
            icon.classList.add("fa-solid", "text-danger"); // filled red
          } else {
            icon.classList.remove("fa-solid", "text-danger");
            icon.classList.add("fa-regular"); // empty
          }
        }
      } catch (err) {
        console.error("Wishlist error:", err);
      }
    });
  });
})();

</script>