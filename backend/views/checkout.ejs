<%- include("includes/head") %>

<div class="mainNavbar">
  <div class="left-section">
    <div class="brand-section">
      <a href="/" class="brand-name" style="text-decoration:none;color:inherit;">Shiv Shakti</a>
      <p class="brand-subtitle">S&nbsp;U&nbsp;I&nbsp;T&nbsp;S</p>
    </div>
  </div>
  </div>

<div class="checkout-wrapper">
    <div class="checkout-container">
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <span class="step-label">Address</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="2">
                <div class="step-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <span class="step-label">Review</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="3">
                <div class="step-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <span class="step-label">Payment</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="checkout-content">
            <!-- Left Column: Forms -->
            <div class="checkout-main">
                
                <!-- Step 1: Address -->
                <div class="checkout-step" id="address-step">
                    <div class="step-card">
                        <h2 class="step-title">
                            <i class="fas fa-map-marker-alt"></i>
                            Delivery Address
                        </h2>
                        
                        <div id="saved-addresses" class="saved-addresses">
                            <% if (addresses && addresses.length) { addresses.forEach(function(addr, idx) { %>
                            <div class="address-card <%= idx === 0 ? 'selected' : '' %>" data-id="<%= addr._id %>" data-fullname="<%= addr.fullName %>" data-phone="<%= addr.phone %>" data-street="<%= addr.street %>" data-landmark="<%= addr.landmark || '' %>" data-city="<%= addr.city %>" data-state="<%= addr.state %>" data-pincode="<%= addr.pincode %>" data-type="<%= addr.type %>">
                                <div class="address-radio">
                                    <input type="radio" name="address" value="<%= addr._id %>" <%= idx === 0 ? 'checked' : '' %> >
                                </div>
                                <div class="address-info">
                                    <h4><%= addr.type %></h4>
                                    <p><%= addr.fullName %></p>
                                    <p><%= addr.street %><% if (addr.landmark) { %>, <%= addr.landmark %><% } %></p>
                                    <p><%= addr.city %>, <%= addr.state %> <%= addr.pincode %></p>
                                    <p>Phone: <%= addr.phone %></p>
                                </div>
                                <div class="address-actions">
                                    <button class="btn-link edit-address" data-id="<%= addr._id %>">Edit</button>
                                    <button class="btn-link delete-address" data-id="<%= addr._id %>">Delete</button>
                                </div>
                            </div>
                            <% }) } else { %>
                              <p>No saved addresses yet.</p>
                            <% } %>
                        </div>

                        <button class="btn-outline" id="add-new-address-btn">
                            <i class="fas fa-plus"></i> Add New Address
                        </button>

                        <!-- Add New Address Form -->
                        <div id="new-address-form" class="address-form" style="display: none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" id="addr-name" placeholder="Enter full name" required>
                                </div>
                                <div class="form-group">
                                    <label>Phone Number *</label>
                                    <input type="tel" id="addr-phone" placeholder="10-digit mobile number" required>
                                </div>
                                <div class="form-group full-width">
                                    <label>Address *</label>
                                    <input type="text" id="addr-street" placeholder="House No., Building Name" required>
                                </div>
                                <div class="form-group full-width">
                                    <label>Landmark</label>
                                    <input type="text" id="addr-landmark" placeholder="E.g. near hospital">
                                </div>
                                <div class="form-group">
                                    <label>City *</label>
                                    <input type="text" id="addr-city" placeholder="City" required>
                                </div>
                                <div class="form-group">
                                    <label>State *</label>
                                    <input type="text" id="addr-state" placeholder="State" required>
                                </div>
                                <div class="form-group">
                                    <label>Pincode *</label>
                                    <input type="text" id="addr-pincode" placeholder="6 digits pincode" required>
                                </div>
                                <div class="form-group">
                                    <label>Address Type</label>
                                    <select id="addr-type">
                                        <option value="Home">Home</option>
                                        <option value="Work">Work</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="btn-primary" id="save-address-btn">Save Address</button>
                                <button class="btn-outline" id="cancel-address-btn">Cancel</button>
                            </div>
                        </div>

                        <button class="btn-primary btn-continue" id="continue-to-review">
                            Continue to Review
                        </button>
                    </div>
                </div>

                <!-- Step 2: Order Review -->
                <div class="checkout-step" id="review-step" style="display: none;">
                    <div class="step-card">
                        <h2 class="step-title">
                            <i class="fas fa-shopping-bag"></i>
                            Order Review
                        </h2>

                        <div class="order-items">
                            <% cart.forEach(item => { %>
                            <div class="order-item">
                                <img src="<%= item.image %>" alt="<%= item.name %>">
                                <div class="item-details">
                                    <h4><%= item.name %></h4>
                                    <p class="item-qty">Quantity: <%= item.qty %></p>
                                    <p class="item-size">Size: <%= item.size %></p>
                                    <p class="item-price">‚Çπ<%= item.salePrice %> √ó <%= item.qty %></p>
                                </div>
                                <div class="item-total">
                                    ‚Çπ<%= item.salePrice * item.qty %>
                                </div>
                            </div>
                            <% }) %>
                        </div>

                        <div class="delivery-info">
                            <h4>Delivering to:</h4>
                            <p id="selected-delivery-address">123 Main Street, New York, NY 10001</p>
                            <button class="btn-link" id="change-address">Change</button>
                        </div>

                        <button class="btn-primary btn-continue" id="continue-to-payment">
                            Continue to Payment
                        </button>
                    </div>
                </div>

                <!-- Step 3: Payment -->
                <div class="checkout-step" id="payment-step" style="display: none;">
                    <div class="step-card">
                        <h2 class="step-title">
                            <i class="fas fa-credit-card"></i>
                            Payment Method
                        </h2>

<form id="payment-form" action="/checkout/place-order" method="POST">
                            <input type="hidden" name="addressId" id="addressId" />
                            <div class="payment-methods">
                                <div class="payment-option">
                                    <input type="radio" id="cod" name="paymentMethod" value="COD" checked>
                                    <label for="cod">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <div>
                                            <strong>Cash on Delivery</strong>
                                            <p>Pay when you receive the product</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="payment-option">
                                    <input type="radio" id="online" name="paymentMethod" value="Online">
                                    <label for="online">
                                        <i class="fas fa-credit-card"></i>
                                        <div>
                                            <strong>Online Payment</strong>
                                            <p>UPI, Cards, Netbanking, Wallets</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn-primary btn-place-order">
                                <i class="fas fa-lock"></i> Place Order
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary -->
            <div class="checkout-sidebar">
                <div class="summary-card">
                    <h3>Price Details</h3>
                    <div class="summary-line">
                        <span>Price (<%= cart.length %> items)</span>
                        <span>‚Çπ<%= cart.reduce((sum, item) => sum + (item.mrp * item.qty), 0).toLocaleString('en-IN') %></span>
                    </div>
                    <div class="summary-line discount">
                        <span>Discount</span>
                        <span class="d1">‚àí‚Çπ<%= cart.reduce((sum, item) => sum + ((item.mrp - item.salePrice) * item.qty), 0).toLocaleString('en-IN') %></span>
                    </div>
                    <div class="summary-line">
                        <span>Delivery Charges</span>
                        <span class="free">FREE</span>
                    </div>
                    <hr>
                    <div class="summary-line total">
                        <strong>Total Amount</strong>
                        <strong>‚Çπ<%= cart.reduce((sum, item) => sum + (item.salePrice * item.qty), 0).toLocaleString('en-IN') %></strong>
                    </div>
                    <div class="savings">
                        You will save ‚Çπ<%= cart.reduce((sum, item) => sum + ((item.mrp - item.salePrice) * item.qty), 0).toLocaleString('en-IN') %> on this order
                    </div>
                </div>

                <div class="secure-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span>100% Secure Payments</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 0;
    padding-top: 80;
}

@media (max-width: 768px) {
    body {
        padding-top: 50;
    }
}

.mainNavbar {
    margin-top: 0;
    top: 0;
}
.brand-section {
    margin-left: 20px;
}

.checkout-wrapper {
    padding: 2rem 1rem;
    max-width: 1400px;
    margin: 0 auto;
    margin-top: 0;
}

.checkout-container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

/* Progress Steps */
.progress-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background: linear-gradient(to right, #f8f9fa, #ffffff);
    border-bottom: 1px solid #e9ecef;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    position: relative;
}

.step-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.step.active .step-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    transform: scale(1.1);
}

.step.completed .step-icon {
    background: #28a745;
    color: white;
}

.step-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #6c757d;
}

.step.active .step-label {
    color: #667eea;
    font-weight: 600;
}

.step-line {
    width: 100px;
    height: 2px;
    background: #e9ecef;
    margin: 0 1rem;
}

.step.completed + .step-line {
    background: #28a745;
}

/* Main Content Layout */
.checkout-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 2rem;
    padding: 2rem;
}

.checkout-main {
    min-height: 500px;
}

/* Step Card */
.step-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    border: 1px solid #e9ecef;
}

.step-title {
    font-size: 1.5rem;
    color: #212529;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.step-title i {
    color: #667eea;
}

/* Address Cards */
.saved-addresses {
    margin-bottom: 1.5rem;
}

.address-card {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.address-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
}

.address-card.selected {
    border-color: #667eea;
    background: #f8f9ff;
}

.address-radio input {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.address-info h4 {
    color: #212529;
    margin-bottom: 0.5rem;
}

.address-info p {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.address-actions {
    margin-left: auto;
    display: flex;
    gap: 1rem;
    align-items: flex-start;
}

/* Forms */
.address-form {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 500;
    color: #495057;
    font-size: 0.9rem;
}

.form-group input,
.form-group select {
    padding: 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Buttons */
.btn-primary,
.btn-outline,
.btn-link {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    font-size: 1rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-outline {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
}

.btn-outline:hover {
    background: #667eea;
    color: white;
}

.btn-link {
    background: none;
    color: #667eea;
    padding: 0.5rem 0;
    text-decoration: underline;
}

.btn-continue {
    width: 100%;
    margin-top: 1.5rem;
}

.btn-place-order {
    width: 100%;
    font-size: 1.1rem;
    padding: 1rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
}

.form-actions button {
    flex: 1;
}

/* Order Items */
.order-items {
    margin-bottom: 1.5rem;
}

.order-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.order-item img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
}

.item-details {
    flex: 1;
}

.item-details h4 {
    color: #212529;
    margin-bottom: 0.5rem;
}

.item-qty,
.item-price {
    color: #6c757d;
    font-size: 0.9rem;
}

.item-total {
    font-size: 1.2rem;
    font-weight: 600;
    color: #212529;
}

/* Delivery Info */
.delivery-info {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 1.5rem;
}

.delivery-info h4 {
    color: #212529;
    margin-bottom: 0.5rem;
}

.delivery-info p {
    color: #6c757d;
    margin-bottom: 0.5rem;
}

/* Payment Methods */
.payment-methods {
    margin-bottom: 2rem;
}

.payment-option {
    margin-bottom: 1rem;
}

.payment-option input[type="radio"] {
    display: none;
}

.payment-option label {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-option label:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
}

.payment-option input[type="radio"]:checked + label {
    border-color: #667eea;
    background: #f8f9ff;
}

.payment-option label i {
    font-size: 1.5rem;
    color: #667eea;
}

.payment-option label strong {
    display: block;
    color: #212529;
    margin-bottom: 0.25rem;
}

.payment-option label p {
    color: #6c757d;
    font-size: 0.85rem;
    margin: 0;
}

/* Summary Card */
.checkout-sidebar {
    position: sticky;
    top: 2rem;
    height: fit-content;
}

.summary-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 15px;
    margin-bottom: 0;
}

.summary-card h3 {
    color: #212529;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    font-weight: 500;
}

.summary-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    color: #6c757d;
    font-size: 1rem;
    font-weight: 500;
}


.summary-line span.d1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.summary-line .free {
    color: #28a745;
    font-weight: 600;
}

.summary-line.total {
    font-size: 1.2rem;
    color: #212529;
    margin-top: 1rem;
}

.summary-card hr {
    border: none;
    border-top: 1px solid #dee2e6;
    margin: 1rem 0;
}

.savings {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 0.75rem;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    margin-top: 1.5rem;
}

.secure-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    border-radius: 10px;
    /* color: #28a745; */
    font-weight: 600;
}

/* Responsive */
@media (max-width: 992px) {
    .checkout-content {
        grid-template-columns: 1fr;
        padding: 0;
    }

    .checkout-sidebar {
        position: static;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .form-actions{
        display: grid;
        grid-template-columns: auto auto;
    }

    .form-group.full-width {
        grid-column: 1;
    }

    .progress-steps {
        padding: 1rem;
    }

    .step-line {
        width: 50px;
    }

    .step-label {
        display: none;
    }
    .step-card{
        padding: 1rem;
    }
    .address-card{
        padding: 0.5rem;
    }
}
</style>

<!-- Razorpay user context for prefill -->
<div id="rzp-user" data-name="<%= user ? (user.name || '') : '' %>" data-email="<%= user ? (user.email || '') : '' %>" style="display:none"></div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const steps = {
        address: document.getElementById('address-step'),
        review: document.getElementById('review-step'),
        payment: document.getElementById('payment-step')
    };

    const progressSteps = document.querySelectorAll('.progress-steps .step');

    // Add New Address
    const addNewAddressBtn = document.getElementById('add-new-address-btn');
    const newAddressForm = document.getElementById('new-address-form');
    const cancelAddressBtn = document.getElementById('cancel-address-btn');

    addNewAddressBtn.addEventListener('click', function() {
        newAddressForm.style.display = 'block';
        addNewAddressBtn.style.display = 'none';
    });

    cancelAddressBtn.addEventListener('click', function() {
        newAddressForm.style.display = 'none';
        addNewAddressBtn.style.display = 'block';
    });

    // Continue to Review
    document.getElementById('continue-to-review').addEventListener('click', function() {
        updateSelectedDeliveryInfo();
        showStep(1);
        updateProgressSteps(1);
    });

    // Continue to Payment
    document.getElementById('continue-to-payment').addEventListener('click', function() {
        showStep(2);
        updateProgressSteps(2);
    });

    // Change Address
    document.getElementById('change-address').addEventListener('click', function() {
        showStep(0);
        updateProgressSteps(0);
    });

    function showStep(stepIndex) {
        Object.values(steps).forEach(step => step.style.display = 'none');
        
        if (stepIndex === 0) steps.address.style.display = 'block';
        else if (stepIndex === 1) steps.review.style.display = 'block';
        else if (stepIndex === 2) steps.payment.style.display = 'block';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateProgressSteps(activeIndex) {
        progressSteps.forEach((step, index) => {
            step.classList.remove('active', 'completed');
            
            if (index < activeIndex) {
                step.classList.add('completed');
            } else if (index === activeIndex) {
                step.classList.add('active');
            }
        });
    }

    // Address Selection + set hidden input
    const addressIdInput = document.getElementById('addressId');
    const preselected = document.querySelector('.address-card.selected input[type="radio"]');
    if (preselected) addressIdInput.value = preselected.value;

    document.querySelectorAll('.address-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (!(e.target && (e.target.classList.contains('edit-address') || e.target.classList.contains('delete-address')))) {
                document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                addressIdInput.value = radio.value;
                if (steps.review.style.display !== 'none') {
                    updateSelectedDeliveryInfo();
                }
            }
        });
    });

    function updateSelectedDeliveryInfo() {
        const card = document.querySelector('.address-card.selected');
        if (!card) return;
        const name = card.dataset.fullname || '';
        const street = card.dataset.street || '';
        const landmark = card.dataset.landmark ? ', ' + card.dataset.landmark : '';
        const city = card.dataset.city || '';
        const state = card.dataset.state || '';
        const pincode = card.dataset.pincode || '';
        const phone = card.dataset.phone || '';
        const text = `${name}, ${street}${landmark}, ${city}, ${state} ${pincode} ‚Äî Phone: ${phone}`;
        const target = document.getElementById('selected-delivery-address');
        if (target) target.textContent = text;
    }

// Save / Update Address
let editingAddressId = null;
document.getElementById('save-address-btn').addEventListener('click', async () => {
  const data = {
    fullName: document.getElementById('addr-name').value,
    phone: document.getElementById('addr-phone').value,
    street: document.getElementById('addr-street').value,
    landmark: document.getElementById('addr-landmark').value,
    city: document.getElementById('addr-city').value,
    state: document.getElementById('addr-state').value,
    pincode: document.getElementById('addr-pincode').value,
    type: document.getElementById('addr-type').value
  };

  const url = editingAddressId ? `/addresses/${editingAddressId}` : '/addresses/add';
  const method = editingAddressId ? 'PUT' : 'POST';

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  const result = await res.json();

  if (result.success) {
    alert(editingAddressId ? '‚úèÔ∏è Address updated!' : '‚úÖ Address saved!');
    location.reload();
  }
});

// Edit Address (prefill)
document.querySelectorAll('.edit-address').forEach(btn => {
  btn.addEventListener('click', function (e) {
    e.stopPropagation();
    const card = this.closest('.address-card');
    editingAddressId = this.dataset.id;
    document.getElementById('addr-name').value = card.dataset.fullname || '';
    document.getElementById('addr-phone').value = card.dataset.phone || '';
    document.getElementById('addr-street').value = card.dataset.street || '';
    document.getElementById('addr-landmark').value = card.dataset.landmark || '';
    document.getElementById('addr-city').value = card.dataset.city || '';
    document.getElementById('addr-state').value = card.dataset.state || '';
    document.getElementById('addr-pincode').value = card.dataset.pincode || '';
    document.getElementById('addr-type').value = card.dataset.type || 'Home';
    newAddressForm.style.display = 'block';
    addNewAddressBtn.style.display = 'none';
  });
});

// Delete Address
document.querySelectorAll('.delete-address').forEach(btn => {
  btn.addEventListener('click', async function (e) {
    e.stopPropagation();
    const addressId = this.dataset.id;
    if (!confirm('Delete this address?')) return;

    const res = await fetch(`/addresses/${addressId}`, { method: 'DELETE' });
    const result = await res.json();

    if (result.success) {
      alert('üóëÔ∏è Address deleted');
      location.reload();
    }
  });
});

// Payment handling (Razorpay for Online)
const paymentForm = document.getElementById('payment-form');
paymentForm.addEventListener('submit', async function (e) {
  const isOnline = document.getElementById('online').checked;
  if (!isOnline) return; // COD - allow default submit

  e.preventDefault();
  if (!addressIdInput.value) {
    alert('Please select a delivery address.');
    return;
  }

  try {
    const orderRes = await fetch('/payment/razorpay/create-order', { method: 'POST' });
    const data = await orderRes.json();
    if (!data.success) {
      alert('Failed to initiate payment');
      return;
    }

    const selectedCard = document.querySelector('.address-card.selected');
    const prefillName = selectedCard?.dataset.fullname || '';
    const prefillPhone = selectedCard?.dataset.phone || '';

    // Resolve theme color from Buy button style (supports gradient by using first stop)
    function rgbToHex(rgb) {
      const m = rgb && rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
      if (!m) return '#667eea';
      const r = (+m[1]).toString(16).padStart(2,'0');
      const g = (+m[2]).toString(16).padStart(2,'0');
      const b = (+m[3]).toString(16).padStart(2,'0');
      return `#${r}${g}${b}`;
    }
    let themeColor = '#667eea';
    const buyBtn = document.querySelector('.btn-primary');
    if (buyBtn) {
      const cs = getComputedStyle(buyBtn);
      if (cs.backgroundImage && cs.backgroundImage !== 'none') {
        const firstColor = cs.backgroundImage.match(/rgba?\([^\)]+\)/);
        if (firstColor) themeColor = rgbToHex(firstColor[0]);
      } else if (cs.backgroundColor) {
        themeColor = rgbToHex(cs.backgroundColor);
      }
    }

    // Use user info for prefill fallback
    const userMeta = document.getElementById('rzp-user');
    const userEmail = userMeta ? userMeta.getAttribute('data-email') : '';
    const effectiveName = (prefillName && prefillName.trim()) ? prefillName : (userMeta ? userMeta.getAttribute('data-name') : '');

    const rzp = new Razorpay({
      key: data.key,
      amount: data.amount,
      currency: data.currency,
      name: 'Shiv Shakti Suits',
      description: effectiveName || 'Order Payment',
      order_id: data.orderId,
      handler: async function (response) {
        const verifyRes = await fetch('/payment/razorpay/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(response)
        });
        const vr = await verifyRes.json();
        if (vr.success) {
          window.location.href = vr.redirect || '/checkout/success';
        } else {
          alert('Payment verification failed');
        }
      },
      prefill: { name: effectiveName, email: userEmail, contact: prefillPhone },
      notes: { customer_name: effectiveName || '', address_id: addressIdInput.value || '' },
      theme: { color: themeColor }
    });
    rzp.open();
  } catch (err) {
    alert('Payment error');
  }
});

});
</script>
